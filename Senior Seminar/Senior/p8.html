<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>p8</title>


<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}

kbd {
  display: inline-block;
  padding: 3px 5px;
  font-size: 11px;
  line-height: 10px;
  color: #555;
  vertical-align: middle;
  background-color: #fcfcfc;
  border: solid 1px #ccc;
  border-bottom-color: #bbb;
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 #bbb
}

* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>


</head>

<body>

<div>
<span style="float: left;">CS 4900, Spring 2019</span>
<span style="float: right;">Dr. Zhiguang Xu</span>
</div>

<p style='clear: left;'></p>

<p><br></p>

<h2 id="toc_0">Project 8: Single Page Application with React Router</h2>

<h3 id="toc_1">Due: March 14, 2019</h3>

<h3 id="toc_2">0.   Introduction</h3>

<blockquote>
<p>This is going to be our last training project. üç∫</p>
</blockquote>

<p>So far, on the <code>/?spa=true</code>page, when the user clicks the &quot;Checkout&quot; button at the bottom of the shopping cart, an ajaxified HTTP request is sent to the server at the url &quot;/orders/new&quot;. However, upon receiving the response, we simply redirect the user to a NEW web page (see the code below) where the order form is displayed so she could place her order. In order words, <strong>the <code>/?spa=true</code>page is not a true SPA.</strong></p>

<pre>
handleCheckout = () => {
    ...
    ...
    axios.get('/orders/new')
      .then(function (response) {
        <b>window.location = response.data.redirect_url;</b>
      })
      .catch(function (error) {
        ...
        ...
    });

}; 
</pre>

<p>In this project, we are going wrap the Depot app up by introducing <span style="color:red"><strong>React Router</strong></span> and using it to transform the <code>/?spa=true</code>page into a true SPA with it -- specifically, when the user clicks the &quot;Checkout&quot; button, we swap out the <code>Catalog</code> react component and swap in<code>OrderForm</code> (a new React component yet to be built) while staying one the same Web page.</p>

<h3 id="toc_3">1.   Project Specifications - Part I</h3>

<h4 id="toc_4">1.1 Install React Router</h4>

<p>Apparently, we need to install React Router. So, run the following commands and restart the servers.</p>

<div><pre><code class="language-none">yarn add react-router react-router-dom webpack-cli
yarn add classnames</code></pre></div>

<blockquote>
<p>The first three packages above are for React Router whereas <a href="https://www.npmjs.com/package/classnames"><code>filenames</code></a> is a handy JavaScript utility for conditionally joining <code>className</code>s together in JSX. We will use it later to conveniently display error messages (if any) in the order form.</p>
</blockquote>

<h4 id="toc_5">1.2 Update the server</h4>

<h5 id="toc_6">1.2.1 The Order model</h5>

<p>In the HTML-based order form, server-generated errors are displayed if certain required fields are missing or could not pass the validation test on the server. </p>

<blockquote>
<p>One exception though: the email format is checked by the HTML 5 &quot;form&quot; on the frontend.</p>
</blockquote>

<p>Here, we&#39;re going to strenghen the server-side validation. Should any field (could be multiple) fail to pass the test, a JSON error message will be sent back to the client.</p>

<p><code>app/models/order.rb</code>:</p>

<div><pre><code class="language-none">class Order &lt; ApplicationRecord
    ...
    ...
    validates :name, :address, :email, :pay_type, presence: true
    validates :email, format: {with: URI::MailTo::EMAIL_REGEXP}
    validates :pay_type, inclusion: pay_types.keys

    ...
    ...
end</code></pre></div>

<h5 id="toc_7">1.2.2 The Cart and Order controllers</h5>

<p>Two controllers need to be updated. </p>

<ul>
<li><p>Update <code>OrdersController</code> in two ways:</p>

<ul>
<li><p>Add a line <code>skip_before_action :verify_authenticity_token</code> at the beginning of the controller to bypass the CSRF protection.</p>

<blockquote>
<p>Remember, in the previous projects, in order to accommendate requests sent by the React components in the frontend, we had to do the same thing in <code>CartsController</code> and <code>LineItemsController</code> too.</p>
</blockquote></li>
<li><p>Update the <code>ensure_cart_isnt_empty</code> function at the end of the controller such that a JSON error message is sent back the React component in the frontend should the user attempt to place an order when there is nothing in her shopping cart.</p></li>
</ul>

<p>Here is the code:</p>

<p><code>app/controllers/orders_controller.rb</code></p>

<pre>
class OrdersController < ApplicationController
    <b>skip_before_action :verify_authenticity_token</b>

    ...
    ...
    ...

      def ensure_cart_isnt_empty
        if @cart.line_items.empty?
          respond_to do |format|
            format.html { redirect_to store_index_url, notice: "Your cart is empty. Can't place order." }
            <b>format.json { render json: {form: "Your cart is empty. Can't place order."}, status: :unprocessable_entity }</b>
          end
        end
      end

end
</pre>  

<p>Also, to facilitate you to test this project more efficiently, in the <code>create</code> method, comment out the line that sends out email.</p>

<div><pre><code class="language-none">...
    # OrderNotifierMailer.received(@order).deliver
...</code></pre></div></li>
<li><p>Update the <code>invalid_cart</code> function at the end of <code>CartsController</code> such that a JSON error message is sent back the React component in the frontend should the user attempt to fetch an invalid cart.</p>

<p><code>app/controllers/orders_controller.rb</code></p>

<div><pre><code class="language-none">class CartsController &lt; ApplicationController
    ...
    ...
    ...

        def invalid_cart
            logger.error &quot;Attempt to access invalid cart #{params[:id]}&quot;

            respond_to do |format|
              format.html { redirect_to store_index_url, notice: &quot;Invalid cart&quot; }
              format.json { render json: {id: &quot;invalid&quot;, line_items: [], total_price: 0} }
            end
        end

end</code></pre></div></li>
</ul>

<p>That is all we need to do on the backend. Everything else stays the same. In all the subsequent sections below, we will switch to and focus on the frontend. </p>

<blockquote>
<p>Git alert</p>
</blockquote>

<h3 id="toc_8">2.   Project Specifications - Part II</h3>

<p>First, before we forget, check the folder <code>app/javascript/packs</code>, if the following two boilerplate files are still there, <strong>REMOVE THEM</strong> and restart the servers.</p>

<ul>
<li><code>applicaiton.js</code></li>
<li><code>hello_react.jsx</code></li>
</ul>

<p>Then, in order for React to be able to switch back and forth between two React components <code>Catalog</code> and <code>OrderForm</code> (yet to be built), we need to setup two React routes -- one for each component. </p>

<p>Hold on ... before we proceed to create our actural React routes, we need to give ourselves a minute to understand <strong>the difference between the Server side routing and the Client side routing</strong>.</p>

<h4 id="toc_9">2.0 Server side routing vs. Client side routing</h4>

<p>The first big thing to understand is that there are now 2 places where a URL say <code>http://example.com/about</code> is interpreted, whereas there used to be only 1 in <em>the old days</em>. In the past, when life was simple, some user sent a request for <code>http://example.com/about</code> to the server, which inspected the path part of the URL, determined the user was requesting the <code>about</code> page and then sent back that page.</p>

<p>With client-side routing, which is what React Router provides, things are less simple. At first, the client does not have any JS code loaded yet. So the very first request will always be to the server. That will then return a page that contains the needed script tags to load React and React Router etc. Only when those scripts have loaded does phase 2 start. In phase 2, when the user clicks on the &quot;About us&quot; navigation link for example, the URL is changed locally only to <code>http://example.com/about</code> (made possible by the History API), but no request to the server is made. Instead, React Router does it&#39;s thing on the client side, determines which React view component to render and renders it, without causing a page refresh. Assuming your about page does not need to make any RESTfull calls, it&#39;s done already. You have transitioned from Home to About Us without any server request having fired.</p>

<p>But now consider what happens if you copy-paste the URL in the address bar and e-mail it to a friend. Your friend has not loaded your website yet. In other words, she is still in phase 1. No React Router is running on her machine yet. So her browser will make a server request to <code>http://example.com/about</code>.</p>

<p><strong>And this is where your trouble starts</strong>. Until now, you could get away with just placing a static HTML at the webroot of your server. But that would give 404 errors for all other URLs when requested from the server. Those same URLs work fine on the client side, because there React Router is doing the routing for you, but they fail on the server side unless you make your server understand them.</p>

<p>So what is the solution?</p>

<p>If we used Node JS as our server so we can run the same JS code on both ends, we could have had all our routes defined in a single react-router config and we didn&#39;t need to duplicate our rendering code. This is &#39;the holy grail&#39; so to speak. The server sends the exact same markup as we would end up with if the page transition had happened on the client. This solution is optimal in terms of SEO.</p>

<p>However, in our Depot application, we have been using Rails as our server and we didn&#39;t consider client routing when building it. So, we are going to take a sub-optimal approach -- <strong>Hash History</strong>. With <code>Hash History</code> instead of <code>Browser History</code>, our URL for the &quot;about&quot; page would look something like this: <code>http://example.com/#/about</code>.  The part after the hash (#) symbol is not sent to the server. So the server only sees <code>http://example.com/</code> and sends the index page as expected. React-Router will pick up the <code>#/about</code> part and show the correct page.</p>

<h4 id="toc_10">2.1 The React Routes</h4>

<p>In the <code>app/javascript/catalog</code> folder, add a new file:</p>

<p><code>app/javascript/catalog/routes.js</code>:</p>

<div><pre><code class="language-none">import React from &#39;react&#39;;

import {
  // BrowserRouter as Router,
  Route,
  Switch,
  HashRouter
} from &#39;react-router-dom&#39;;

import Catalog from &quot;./components/Catalog&quot;;
import OrderForm from &quot;../order_form/components/OrderForm&quot;;

const App = (props) =&gt; (
  &lt;HashRouter cart_id={props.cart_id}&gt;
    &lt;div&gt;
      &lt;Switch&gt;
          &lt;Route 
                exact path=&#39;/&#39; 
                render={(routerProps) =&gt; &lt;Catalog {...routerProps} {...props} /&gt;} 
            /&gt;
            &lt;Route 
                exact path=&#39;/order_form&#39; 
                render={(routerProps) =&gt; &lt;OrderForm {...routerProps} {...props} /&gt;} 
            /&gt;
        &lt;/Switch&gt;
    &lt;/div&gt;
  &lt;/HashRouter&gt;
)
export default App;</code></pre></div>

<p>Notes:</p>

<ul>
<li>According to the <code>routes.js</code> file above, when the user attempts to go to <code>/</code> path (aka. rotue), the <code>Catalog</code> React component is rendered; similarly, when the user attempts to go to <code>/order_form</code> path, the <code>OrderForm</code> React component is rendered.</li>
<li>For each component, the ES6 spread operator (<code>...</code>) is used such that both regular <code>props</code> and <code>routeProps</code> could be passed into it. As you could see, <code>cart_id</code> is one of such <code>routeProps</code>.</li>
<li>As stated in section 2.0 above, admittedly, <code>HashRouter</code> is not the best choice here. However, considering the fact that we built our server on Rails and the time constraints for this class, it&#39;s acceptable.</li>
</ul>

<p>Then in the same folder, update <code>app/javascript/catalog/index.js</code>:</p>

<div><pre><code class="language-none">import React from &quot;react&quot;;
import ReactDOM from &quot;react-dom&quot;;
import App from &#39;./routes&#39;;

document.addEventListener(&quot;DOMContentLoaded&quot;, () =&gt; {
    const catalog = document.querySelector(&quot;#catalog&quot;);
    const cart_id = JSON.parse(catalog.getAttribute(&quot;cart_id&quot;));
    const seller = JSON.parse(catalog.getAttribute(&quot;seller&quot;));
    ReactDOM.render(&lt;App cart_id={cart_id} seller={seller} /&gt;, catalog);
});</code></pre></div>

<h4 id="toc_11">2.2 The <code>Cart</code> React Component Contained in the<code>Catalog</code> Component</h4>

<p>Navigate to the <code>app/javascript/catalog/components</code> folder. Notice that the <code>Catalog</code> React component contains three sub-components: <code>BookList</code>, <code>SearchForm</code>, and <code>Cart</code>.</p>

<p>Update <code>app/javascript/catalog/components/Cart.jsx</code> such that when the &quot;Checkout&quot; button is clicked, we don&#39;t redirect the user to another web page lile what we&#39;ve been doing so far, instead, through the <code>Link</code> component that we import from the <code>react-router-dom</code> package, <span style="color:red"><strong>we switch to the <code>OrderForm</code> component while staying on the same SPA!</strong></span></p>

<div><pre><code class="language-none">...
...
import { Link } from &quot;react-router-dom&quot;;
export default class Cart extends React.Component {
    ...
    ...
    ...
    render = () =&gt; {
        ...
        ...
        ...
              &amp;nbsp;
              {
                // &lt;a className=&quot;btn btn-success&quot;
                //  onClick={this.handleCheckout} &gt;
                // Checkout
                // &lt;/a&gt;
              }
              &lt;Link className=&quot;btn btn-success&quot; to={{pathname:&quot;/order_form&quot;}}&gt;
                  Checkout
              &lt;/Link&gt;

              ...
              ...
        ...
        ...
    }
}</code></pre></div>

<h4 id="toc_12">2.3 The <code>OrderForm</code> React Component, <span style="color:green"><strong>Ver. 1.0</strong></span></h4>

<blockquote>
<p>In Project 6, in the <code>app/javascript/order_form</code> folder (and its sub-folder <code>components/</code>), we have created a React component <code>PayTypeSelector</code> and rendered it in the Rails view <code>app/views/orders/_form.html.erb</code> for orders. </p>

<p>In this section, we are going to create a React component <code>OrderForm</code>, which includes the <code>PayTypeSelector</code> as part of it as well. In other words, <code>PayTypeSelector</code> is a <strong>usable component</strong>.</p>
</blockquote>

<p>In the <code>app/javascript/order_form/components</code> folder, create a new React component:</p>

<p><code>app/javascript/order_form/components/OrderForm.jsx</code>:</p>

<div><pre><code class="language-none">import React from &quot;react&quot;;
import axios from &quot;axios&quot;;
import { Link } from &quot;react-router-dom&quot;;

export default class OrderForm extends React.Component {
    render = () =&gt; {

        return (
            &lt;div className=&quot;container&quot;&gt;
                &lt;h2&gt;Please Enter Your Details&lt;/h2&gt;
                &lt;form&gt;
                    &lt;div className=&quot;actions&quot; align=&quot;right&quot;&gt;
                        &lt;Link className=&quot;btn btn-success&quot; to={{pathname:&quot;/&quot;}}&gt;
                            Cancel
                        &lt;/Link&gt;
                    &lt;/div&gt;
                &lt;/form&gt;
            &lt;/div&gt;
        );
    };
}</code></pre></div>

<p>Now, on the SPA catalog page, add some products to your cart, click &quot;Checkout&quot;, the <code>#/order_form/</code> page should be rendered; click &quot;Cancel&quot;, you should be back to the <code>#/</code> page. <span style="color:red"><strong>You are not allowed to proceed to the next step without completing this test.</strong></span></p>

<blockquote>
<p>Git alert</p>
</blockquote>

<h3 id="toc_13">3.   Project Specifications - Part III</h3>

<h4 id="toc_14">3.1 The <code>Cart</code> React Component Revisited</h4>

<p>The <code>OrderForm</code> component that we started to build in section 2.3 above will eventually have a shopping cart on the top (just like the one on the top of the <code>Catalog</code> component) and a form for the user to fill up at the bottom. Therefore, the <code>Cart</code> component is actually <strong>a reusable component</strong> contained in both <code>Catalog</code> and <code>OrderForm</code> components with one minor difference -- <code>Cart</code> in <code>Catalog</code> has both the <code>Empty Cart</code> and <code>Checkout</code> buttons whereas <code>Cart</code> in <code>OrderForm</code> only has<code>Empty Cart</code>.</p>

<p>Three components need to be updated:</p>

<ul>
<li><p>In this new version of the <code>OrderForm</code> component (<span style="color:green"><strong>Ver. 2.0</strong></span>), thanks to React Router, the current url (i.e. &quot;#/order_form&quot;) is obtained through <code>this.props.match.url</code>, which is passed to <code>Cart</code> as a property.</p>

<p><code>app/javascript/order_form/components/OrderForm.jsx</code>:</p>

<div><pre><code class="language-none">...
...
import Cart from &#39;../../catalog/components/Cart&#39;;

export default class OrderForm extends React.Component {
    handlePopularity = (books) =&gt; {
        // This is simply an empty placeholder method since on the OrderForm page, there is no &quot;popularity&quot; to update.
    };

    render = () =&gt; {
        return (
            &lt;div className=&quot;container&quot;&gt;
                &lt;div className=&quot;row&quot;&gt;
                    &lt;div className=&quot;col-md-12 pull-right&quot;&gt;
                        &lt;Cart ref=&quot;cart&quot; id={this.props.cart_id} handlePopularity={this.handlePopularity} url={this.props.match.url}/&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;h2&gt;Please Enter Your Details&lt;/h2&gt;
                ...
                ...
            &lt;/div&gt;
        );
    };
}   </code></pre></div></li>
<li><p>In the <code>Catalog</code> component, same as above.
<code>app/javascript/catalog/components/Catalog.jsx</code>:</p>

<div><pre><code class="language-none">...
...
...
        &lt;Cart ref=&quot;cart&quot; id={this.props.cart_id} handlePopularity={this.handlePopularity} url={this.props.match.url}/&gt;
...
...</code></pre></div></li>
<li><p>In he <code>Cart</code> component, </p>

<p><code>app/javascript/catalog/components/Cart.jsx</code>:</p>

<div><pre><code class="language-none">...
...
...
export default class Cart extends React.Component {
    ...
    ...
    ...

     render = () =&gt; {
        if (this.state.total_price != 0) {

          var buttons = (this.props.url != &quot;/order_form&quot;) ?
          (
            &lt;div&gt;
              &lt;a className=&quot;btn btn-success&quot; 
                 onClick={this.handleEmptyCart} &gt;
                 Empty Cart
              &lt;/a&gt;
              &amp;nbsp;
              &lt;Link className=&quot;btn btn-success&quot; to={{pathname:&quot;/order_form&quot;}}&gt;
                  Checkout
              &lt;/Link&gt;
            &lt;/div&gt;
          )
          :
          (
             &lt;a className=&quot;btn btn-success&quot;
                onClick={this.handleEmptyCart} &gt;
              Empty Cart
             &lt;/a&gt;
          )    

          return(
            &lt;div className=&quot;spa_cart&quot;&gt;
              &lt;h2&gt;Your Cart&lt;/h2&gt;

              &lt;LineItems total_price={this.state.total_price}
                         line_items={this.state.line_items} 
                         handleRemoveFromCart={this.handleRemoveFromCart} /&gt;

              {buttons}
            &lt;/div&gt;
          )
        }
        else {
          return (
            &lt;div className=&quot;spa_cart&quot;&gt;
              &lt;h2&gt;Your Cart&lt;/h2&gt;
            &lt;/div&gt;
          );
        }
      }
}</code></pre></div>

<p>Also, you should comment out the entire <code>handleCheckout</code> method since it is no longer needed.</p></li>
</ul>

<p>Now, check the cart and see if it looks right on both the catalog page and the order form page. <span style="color:red"><strong>You are not allowed to proceed to the next step without completing this test.</strong></span></p>

<blockquote>
<p>Git alert</p>
</blockquote>

<h4 id="toc_15">3.2 The <code>OrderForm</code> React Component, <span style="color:green"><strong>Ver 3.0</strong></span></h4>

<p>The <code>OrderForm</code> <span style="color:green"><strong>Ver. 1.0</strong></span> that we created in section 2.3 above was very simple. It barely contained anything except a &quot;Cancel&quot; button in order for us to test the React routes. Then in setion 3.1, <code>OrderForm</code><span style="color:green"><strong>Ver. 2.0</strong></span> was updated to contain the <code>Cart</code> component at its top. In this section, we are going to complete it. </p>

<p>This is probabaly the most complicated part of this entire project so hold on tight. The <code>OrderForm</code> component will</p>

<ul>
<li>contain the <code>Cart</code> component like <code>Catalog</code> does (done in section 3.1 above)</li>
<li>contain input fields for name, address, and email</li>
<li>contain the <code>PayTypeSelector</code> component like the Rails view based order form does</li>
<li>be able to invoke a function to send an HTTP post request to place order when the user clicks the &quot;Submit&quot; button at the bottom of the form</li>
<li>use the <code>classnames</code> package to conditionally display error messages received from the server</li>
</ul>

<p>Let&#39;s see the code.</p>

<blockquote>
<p>In class, I will elaborate the <code>OrderForm</code> component. <span style="color:red"><strong>Your full attention is demanded then.</strong></span></p>
</blockquote>

<p><code>app/javascript/order_form/components/OrderForm.jsx</code>:</p>

<div><pre><code class="language-none">import React from &quot;react&quot;;
import axios from &quot;axios&quot;;
import { Link } from &quot;react-router-dom&quot;;

import Cart from &#39;../../catalog/components/Cart&#39;;
import PayTypeSelector from &#39;./PayTypeSelector&#39;;
import classnames from &quot;classnames&quot;;

export default class OrderForm extends React.Component {

    constructor(props) {
        super(props);
        this.state = {
            name: &quot;&quot;,
            address: &quot;&quot;,
            email: &quot;&quot;,
            pay_type: &quot;&quot;,
            errors: {}
        };
        this.onInputChange = this.onInputChange.bind(this);
        this.onFormSubmit = this.onFormSubmit.bind(this);
    }

    onFormSubmit(event) {
        event.preventDefault();

        const newOrder = {
            name: this.state.name,
            address: this.state.address,
            email: this.state.email,
            pay_type: this.state.pay_type
        };

        var self = this;
        axios.defaults.headers.common[&quot;X-Requested-With&quot;] = &quot;XMLHttpRequest&quot;;
        axios
            .post(&quot;/orders&quot;, { ...newOrder })
            .then(function(response) {
                console.log(response.data);
                self.props.history.push({
                  pathname: &#39;/&#39;
                });
            })
            .catch(function(error) {
                console.log(error.response);
                // alert(&quot;Cannot place order: &quot;, error);
                self.setState({errors: error.response.data})
            });
    }

    onInputChange(e) {
        this.setState({ [e.target.name]: e.target.value });
    }

    handlePopularity = (books) =&gt; {

    };

    handleSelectPayType = selected_pay_type =&gt; {
        // console.log(selected_pay_type);
        this.setState( {pay_type: selected_pay_type});
    }

    render = () =&gt; {
        const { errors } = this.state;
        console.log(errors)

        return (
            &lt;div className=&quot;container&quot;&gt;
                &lt;div className=&quot;row&quot;&gt;
                    &lt;div className=&quot;col-md-12 pull-right&quot;&gt;
                        &lt;Cart ref=&quot;cart&quot; id={this.props.cart_id} handlePopularity={this.handlePopularity} url={this.props.match.url}/&gt;
                    &lt;/div&gt;
                &lt;/div&gt;

                &lt;h2&gt;Please Enter Your Details&lt;/h2&gt;
                &lt;form noValidate onSubmit={this.onFormSubmit}&gt;
                    &lt;div&gt;
                        {errors.form &amp;&amp; (
                            &lt;div className=&quot;invalid-feedback&quot; style={{display: &quot;block&quot;}}&gt;
                                {errors.form}
                            &lt;/div&gt;
                        )}
                    &lt;/div&gt;

                    &lt;div className=&quot;form-group&quot;&gt;
                        &lt;input
                            type=&quot;text&quot;
                            className={classnames(
                                &quot;form-control form-control-lg&quot;,
                                { &quot;is-invalid&quot;: errors.name }
                            )}
                               placeholder=&quot;Name&quot;
                            name=&quot;name&quot;
                            value={this.state.name}
                            onChange={this.onInputChange}
                        /&gt;
                        {errors.name &amp;&amp; (
                            &lt;div className=&quot;invalid-feedback&quot;&gt;
                                {errors.name}
                            &lt;/div&gt;
                        )}
                    &lt;/div&gt;
                    &lt;div className=&quot;form-group&quot;&gt;
                        &lt;input
                            type=&quot;address&quot;
                            className={classnames(
                                &quot;form-control form-control-lg&quot;,
                                { &quot;is-invalid&quot;: errors.address }
                            )}
                            placeholder=&quot;Address&quot;
                            name=&quot;address&quot;
                            value={this.state.address}
                            onChange={this.onInputChange}
                        /&gt;
                        {errors.address &amp;&amp; (
                            &lt;div className=&quot;invalid-feedback&quot;&gt;
                                {errors.address}
                            &lt;/div&gt;
                        )}
                    &lt;/div&gt;
                    &lt;div className=&quot;form-group&quot;&gt;
                        &lt;input
                            type=&quot;email&quot;
                            className={classnames(
                                &quot;form-control form-control-lg&quot;,
                                {
                                    &quot;is-invalid&quot;:
                                        errors.email
                                }
                            )}
                            placeholder=&quot;Email&quot;
                            name=&quot;email&quot;
                            value={this.state.email}
                            onChange={this.onInputChange}
                        /&gt;
                        {errors.email &amp;&amp; (
                            &lt;div className=&quot;invalid-feedback&quot;&gt;
                                {errors.email.join(&quot;, &quot;)}
                            &lt;/div&gt;
                        )}
                    &lt;/div&gt;

                    &lt;div className=&quot;form-group&quot;&gt;
                    &lt;div&gt;
                        &lt;PayTypeSelector handleSelectPayType={this.handleSelectPayType} /&gt;
                    &lt;/div&gt;
                        {errors.pay_type &amp;&amp; (
                            &lt;div className=&quot;invalid-feedback&quot; style={{display: &quot;block&quot;}}&gt;
                                {errors.pay_type.join(&quot;, &quot;)}
                            &lt;/div&gt;
                        )}
                    &lt;/div&gt;


                    &lt;div className=&quot;actions&quot; align=&quot;right&quot;&gt;
                        &lt;input
                            type=&quot;submit&quot;
                            className=&quot;btn btn-success&quot;
                        /&gt;
                        &amp;nbsp;
                        &lt;Link className=&quot;btn btn-success&quot; to={{pathname:&quot;/&quot;}}&gt;
                            Cancel
                        &lt;/Link&gt;
                    &lt;/div&gt;
                &lt;/form&gt;
            &lt;/div&gt;
        );
    };
}</code></pre></div>

<p>In order for the <code>PayTypeSelector</code> component to fit in <code>OrderForm</code>, it needs a couple of updates:</p>

<p><code>app/javascript/order_form/components/PayTypeSelector.jsx</code>:</p>

<div><pre><code class="language-none">...
...
export default class PayTypeSelector extends React.Component {
    ...
    onPayTypeSelected(event) {
        this.setState({ selectedPayType: event.target.value });
        if (this.props.handleSelectPayType) {
          this.props.handleSelectPayType(event.target.value);
        }
    }
    render() {
        ...
        ...
                 &lt;select className=&quot;form-control form-control-lg&quot; id=&quot;pay_type&quot; onChange={this.onPayTypeSelected} name=&quot;order[pay_type]&quot;&gt;
        ...
        ...

    }
}</code></pre></div>

<p>Correspondingly, <code>CheckPayType</code>, <code>CreditCardPayType</code>, and <code>PurchaseOrderPayType</code> all need to be updated too. Find <code>CheckPayType</code> below. <strong>Make sure you update the other two components in the similar way.</strong></p>

<p><code>app/javascript/order_form/components/CheckPayType.jsx</code>:</p>

<div><pre><code class="language-none">import React from &#39;react&#39;

export default class CheckPayType extends React.Component {
        ...
        ...
          &lt;input type=&quot;password&quot;
                 name=&quot;order[routing_number]&quot; 
                 id=&quot;order_routing_number&quot;
                 className=&quot;form-control form-control-lg&quot; /&gt;
        ...
        ...
          &lt;input type=&quot;text&quot;
                 name=&quot;order[account_number]&quot; 
                 id=&quot;order_account_number&quot;
                 className=&quot;form-control form-control-lg&quot; /&gt;
}</code></pre></div>

<p>Add some products in cart and place an order. <span style="color:red"><strong>You are not allowed to proceed to the next step without completing this test.</strong></span></p>

<blockquote>
<p>Git alert</p>
</blockquote>

<h3 id="toc_16">4.   Project Specifications - Part IV</h3>

<p><strong>There is a big bug</strong>: on the catalog page, if you empty your cart, add some products (into a new cart), and click &quot;Checkout&quot;, the cart will fail to display on the OrderFrom page. This is because after the new cart is created, although a new cart id is added to the Cart&#39;s state, React Router still uses the old (invalid) cart id when transferring to the OrderForm page. </p>

<p>So let&#39;s fix the bug.</p>

<ul>
<li><p>In the <code>Cart</code> component, </p>

<p><code>app/javascript/catalog/components/Cart.jsx</code>:</p>

<div><pre><code class="language-none">...
...
              {
                //  Since on the catalog page, a new cart id will be generated after the cart is emptied and then recreated,
                //  we need to pass the true (and new) cart id to &quot;Link&quot; such that the cart on the OrderForm page could be properly rendered.
              }
              &lt;Link className=&quot;btn btn-success&quot; to={{pathname:&quot;/order_form&quot;, true_cart_id: this.state.id}}&gt;
                Checkout
             &lt;/Link&gt;
...</code></pre></div></li>
<li><p>In the <code>OrderForm</code> component, </p>

<p><code>app/javascript/order_form/components/OrderForm.jsx</code>:</p>

<div><pre><code class="language-none">...
...
        render = () =&gt; {
            const { errors } = this.state;
            console.log(errors)

            // If cart has been emptied and then created on the catalog page, the 
            // true card id will come in this way. Refer to the Link component in Cart.jsx in the previous step.
            // 
            // ES6 destructing assginment syntax
            var {true_cart_id} = this.props.location

            return (
                    ...
                                &lt;Cart ref=&quot;cart&quot; id={true_cart_id ? true_cart_id : this.props.cart_id} handlePopularity={this.handlePopularity} url={this.props.match.url}/&gt;

                    ...
                    ...
                                &lt;Link className=&quot;btn btn-success&quot; to={{pathname:&quot;/&quot;, true_cart_id: true_cart_id }}&gt;
                                    Cancel
                                &lt;/Link&gt;
                    ...
                    ...
            )
         }
}</code></pre></div></li>
<li><p>In the <code>Catalog</code> component, </p>

<p><code>app/javascript/catalog/components/Catalog.jsx</code>:</p>

<div><pre><code class="language-none">...
...
        render = () =&gt; {
            // If there is true_cart_id from the Cancel Link (see OrderForm in the previous step), we will use it.
            // ES6 destructing assginment syntax
            var {true_cart_id} = this.props.location

            return (
                ...
                ...
                                &lt;Cart ref=&quot;cart&quot; id={true_cart_id ? true_cart_id : this.props.cart_id} handlePopularity={this.handlePopularity} url={this.props.match.url}/&gt;

                ...
                ...
            )
        }
}</code></pre></div></li>
</ul>

<p>Now, give your app a thorough test between the catalog and order form pages. Everthing should work. <span style="color:red"><strong>You are not allowed to proceed to the next step without completing this test.</strong></span></p>

<blockquote>
<p>Git alert</p>
</blockquote>

<h3 id="toc_17">5. Project Specifications - Part V</h3>

<p>In projec 7, when a buyer places her order, her email address and information in her profile are automatically used to pre-fill the order form, including the <code>PayTypeSelector</code> React.js component contained in the order form.</p>

<p><span style="color:red"><strong>In this part, you are challenged to do the same but for the <code>OrderForm</code> component in the SPA page (including <code>PayTypeSelector</code> of course).</strong></span></p>

<p>Hint:</p>

<ul>
<li>In <code>index_spa.html.erb</code>, you pass all necessary information of the buyer as props to the <code>Catalog</code> react component (through <code>app/javascript/catalog/index.js</code> of course).</li>
<li><code>Catalog</code> in turn passes them as props to <code>Cart</code>.</li>
<li><code>Cart</code>, through <code>Link</code>,  passes them as router props to <code>OrderForm</code>.</li>
<li><code>OrderForm</code> fills up the name, address, email fields with the buyer&#39;s information. It then passes the buyer&#39;s pay type as props to <code>PayTypeSelector</code>.</li>
<li> Finally, <code>PayTypeSelector</code> selects the default pay type accordingly.</li>
</ul>

<h3 id="toc_18">6. Project Specifications - Part VI</h3>

<p>First, remove the alias <code>heroku</code> that you made in project 7.</p>

<div><pre><code class="language-none">git remote rm heroku</code></pre></div>

<p>Then login to Heroku and create a project.</p>

<div><pre><code class="language-none">heroku login
heroku create project8-yourfirstname-yourlastname</code></pre></div>

<p>Update the two &quot;action_cable&quot; lines in <code>config/environments/production.rb</code> to accommodate project6. </p>

<p>Re-create <code>config/application.yml</code> for sending email through SendGrid (project 6):</p>

<div><pre><code class="language-none">SENDGRID_USERNAME: &lt;your_sendgrid_username&gt;
SENDGRID_PASSWORD: &lt;your_sendgrid_username&gt;</code></pre></div>

<p>Git stage and commit the codebase.</p>

<p>Then do the configurations and deployment as summarize below:</p>

<div><pre><code class="language-none">heroku config:set S3_ACCESS_KEY=&lt;access key&gt;.   =&gt; These four are for storing images on AWS S3 (project 2)
heroku config:set S3_SECRET_KEY=&lt;secret key&gt;
heroku config:set AWS_REGION =&lt;aws region&gt;
heroku config:set S3_BUCKET=&lt;bucket name&gt;

figaro heroku:set -e production                 =&gt; This is for sending emails via SendGrid (project 6)

git push heroku master:master                   =&gt; Heroku deployment (project 6)

heroku addons:add redistogo                     =&gt; Redis (project 5)

heroku pg:reset DATABASE                        =&gt; These three are for the database (projects 2~6)
heroku run rails db:migrate

heroku run rails runner lib/create_sellers_and_products.rb   =&gt; project 7
heroku run rails runner lib/create_super_account.rb          =&gt; project 7

heroku run rails runner lib/load_orders.rb      =&gt; This is for testing pagination (project 6)</code></pre></div>

<h3 id="toc_19">7.   What to Turn in?</h3>

<ul>
<li><p>Final version of the project source code pushed onto Github</p>

<p><span style="color:red">Alert: <strong>Don&#39;t push your P8 to the master branch onto your Github repository  until I explicitly tell you so on BlazeVIEW</strong>. I need to pull your Project 7 down for grading purposes first before you overwrite it with the code for this Project 8.</span></p></li>
<li><p>Final version of the project deployed on Heroku. You must name your application on Heroku:</p>

<div><pre><code class="language-none">http://project8-yourfirstname-yourlastname.herokuapp.com</code></pre></div></li>
<li><p>The Git log file reflecting the full history of your project submitted on BlazeVIEW</p></li>
</ul>




</body>

</html>
